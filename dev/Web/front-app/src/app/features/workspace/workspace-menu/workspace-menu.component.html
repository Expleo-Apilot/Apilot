<div class="workspace-menu-container">
  <!-- Fixed Header Section -->
  <div class="workspace-menu-header">
    <h2>Workspaces</h2>
    <button mat-icon-button (click)="closeMenu.emit()" class="close-button">
      <mat-icon>close</mat-icon>
    </button>
  </div>

  <div class="workspace-menu-actions">
    <button mat-flat-button color="primary" class="create-btn" (click)="openCreateModal()">
      <mat-icon>add</mat-icon>
      Create Workspace
    </button>
    <div class="search-box">
      <mat-icon>search</mat-icon>
      <input [(ngModel)]="search" placeholder="Search workspaces" aria-label="Search workspaces" />
      <button *ngIf="search" mat-icon-button class="clear-search" (click)="search = ''">
        <mat-icon>close</mat-icon>
      </button>
    </div>
  </div>

  <div class="workspace-tabs">
    <div class="tab" [class.active]="activeTab === 'all'" (click)="setActiveTab('all')">All</div>
    <div class="tab" [class.active]="activeTab === 'personal'" (click)="setActiveTab('personal')">Personal</div>
    <div class="tab" [class.active]="activeTab === 'team'" (click)="setActiveTab('team')">Team</div>
  </div>

  <mat-divider></mat-divider>

  <!-- Scrollable Content Area -->
  <div class="workspace-content-scrollable">

  <!-- Recent Workspaces Section -->
  <div class="workspace-section" *ngIf="recentWorkspaces.length > 0">
    <div class="section-header">
      <div class="section-label">Recently visited</div>
      <div class="section-count">{{recentWorkspaces.length}}</div>
    </div>

    <div class="workspace-list">
      <div *ngFor="let ws of recentWorkspaces" class="workspace-item"
           [class.active]="ws.id === selectedWorkspaceId"
           (click)="selectWorkspace(ws)">
        <div class="workspace-icon" [ngClass]="{'personal': getWorkspaceIcon(ws) === 'lock', 'team': getWorkspaceIcon(ws) === 'groups'}">
          <mat-icon>{{getWorkspaceIcon(ws)}}</mat-icon>
        </div>
        <div class="workspace-details">
          <div class="workspace-name">{{ws.name}}</div>
          <div class="workspace-meta">{{ws.description || 'No description'}}</div>
        </div>
        <div class="workspace-actions">
          <button mat-icon-button (click)="openEditModal(ws); $event.stopPropagation()" aria-label="Edit workspace">
            <mat-icon>edit</mat-icon>
          </button>
          <button mat-icon-button (click)="deleteWorkspace(ws, $event)" aria-label="Delete workspace">
            <mat-icon>delete</mat-icon>
          </button>
        </div>
      </div>
    </div>

    <mat-divider></mat-divider>
  </div>

  <!-- All Workspaces Section -->
  <div class="workspace-section">
    <div class="section-header">
      <div class="section-label">{{activeTab === 'all' ? 'All workspaces' : (activeTab === 'personal' ? 'Personal workspaces' : 'Team workspaces')}}</div>
      <div class="section-count">{{moreWorkspaces.length}}</div>
    </div>

    <div *ngIf="moreWorkspaces.length === 0" class="no-workspaces">
      <mat-icon>work_outline</mat-icon>
      <span>No workspaces found</span>
    </div>

    <div class="workspace-list">
      <div *ngFor="let ws of moreWorkspaces" class="workspace-item"
           [class.active]="ws.id === selectedWorkspaceId"
           (click)="selectWorkspace(ws)">
        <div class="workspace-icon" [ngClass]="{'personal': getWorkspaceIcon(ws) === 'lock', 'team': getWorkspaceIcon(ws) === 'groups'}">
          <mat-icon>{{getWorkspaceIcon(ws)}}</mat-icon>
        </div>
        <div class="workspace-details">
          <div class="workspace-name">{{ws.name}}</div>
          <div class="workspace-meta">{{ws.description || 'No description'}}</div>
        </div>
        <div class="workspace-actions">
          <button mat-icon-button (click)="openEditModal(ws); $event.stopPropagation()" aria-label="Edit workspace">
            <mat-icon>edit</mat-icon>
          </button>
          <button mat-icon-button (click)="deleteWorkspace(ws, $event)" aria-label="Delete workspace">
            <mat-icon>delete</mat-icon>
          </button>
        </div>
      </div>
    </div>
  </div>
  </div> <!-- Close the scrollable content area -->

  <!-- Workspace Selection Button -->
  <div class="workspace-menu-footer">
    <button mat-flat-button color="primary" class="select-workspace-btn" (click)="openWorkspacesModal()">
      <mat-icon>list</mat-icon>
      Show All Workspaces
    </button>
  </div>
</div>

<!-- Create/Edit Modal -->
<div class="modal-backdrop" *ngIf="showCreateModal || showEditModal" (click)="closeModal()"></div>
<div class="modal" *ngIf="showCreateModal || showEditModal" tabindex="0" (keydown.escape)="closeModal()">
  <div class="modal-header">
    <h2>{{ showCreateModal ? 'Create Workspace' : 'Edit Workspace' }}</h2>
    <button mat-icon-button (click)="closeModal()" aria-label="Close modal">
      <mat-icon>close</mat-icon>
    </button>
  </div>

  <form (ngSubmit)="showCreateModal ? createWorkspace() : updateWorkspace()" (click)="$event.stopPropagation()">
    <div class="modal-content">
      <div class="workspace-type-selector" *ngIf="showCreateModal">
        <div class="type-option selected">
          <mat-icon>lock</mat-icon>
          <div class="type-details">
            <div class="type-name">Personal</div>
            <div class="type-description">Private workspace for your personal use</div>
          </div>
        </div>
        <div class="type-option">
          <mat-icon>groups</mat-icon>
          <div class="type-details">
            <div class="type-name">Team</div>
            <div class="type-description">Shared workspace for team collaboration</div>
          </div>
        </div>
      </div>

      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Name</mat-label>
        <input matInput [(ngModel)]="modalWorkspace.name" name="name" required #nameInput="ngModel">
        <mat-error *ngIf="nameInput.invalid && nameInput.touched">Name is required</mat-error>
      </mat-form-field>

      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Summary</mat-label>
        <textarea matInput [(ngModel)]="modalWorkspace.description" name="description" rows="3" placeholder="A brief description of this workspace"></textarea>
      </mat-form-field>

      <div *ngIf="errorMsg" class="error-message">{{ errorMsg }}</div>
    </div>

    <div class="modal-actions">
      <button mat-stroked-button type="button" (click)="closeModal()">Cancel</button>
      <button mat-flat-button color="primary" type="submit" [disabled]="isSubmitting || !modalWorkspace.name">
        {{ isSubmitting ? (showCreateModal ? 'Creating…' : 'Saving…') : (showCreateModal ? 'Create' : 'Save') }}
      </button>
    </div>
  </form>
</div>

<!-- Show Workspaces Modal -->
<div class="modal-backdrop" *ngIf="showWorkspacesModal" (click)="closeWorkspacesModal()"></div>
<div class="modal workspaces-modal" *ngIf="showWorkspacesModal" tabindex="0" (keydown.escape)="closeWorkspacesModal()">
  <div class="modal-header">
    <h2>Select Workspace</h2>
    <button mat-icon-button (click)="closeWorkspacesModal()" aria-label="Close modal">
      <mat-icon>close</mat-icon>
    </button>
  </div>

  <div class="modal-content">
    <div class="workspaces-list">
      <div *ngFor="let ws of filteredWorkspaces" class="workspace-item"
           [class.active]="ws.id === selectedWorkspaceId"
           (click)="selectWorkspaceAndClose(ws)">
        <div class="workspace-icon" [ngClass]="{'personal': getWorkspaceIcon(ws) === 'lock', 'team': getWorkspaceIcon(ws) === 'groups'}">
          <mat-icon>{{getWorkspaceIcon(ws)}}</mat-icon>
        </div>
        <div class="workspace-details">
          <div class="workspace-name">{{ws.name}}</div>
          <div class="workspace-meta">{{ws.description || 'No description'}}</div>
        </div>
        <div class="workspace-actions">
          <button mat-icon-button (click)="openEditModal(ws); $event.stopPropagation()" aria-label="Edit workspace">
            <mat-icon>edit</mat-icon>
          </button>
          <button mat-icon-button (click)="deleteWorkspace(ws, $event)" aria-label="Delete workspace">
            <mat-icon>delete</mat-icon>
          </button>
        </div>
      </div>
      
      <div class="workspace-item create-new" (click)="openCreateModal()">
        <div class="workspace-icon add">
          <mat-icon>add</mat-icon>
        </div>
        <div class="workspace-details">
          <div class="workspace-name">Create New Workspace</div>
        </div>
      </div>
    </div>
  </div>
</div>
